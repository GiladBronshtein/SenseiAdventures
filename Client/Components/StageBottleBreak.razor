@inject IJSRuntime JS
@inject HttpClient Http
@inject NavigationManager Nav
@using template.Shared.Models.Games;
@using template.Shared.Models.Users;


<div class="container-fluid">



    <!-- ROW 1 - TITLE -->
    <div class="row mb-4">
        <div class="col-md-7">
            <h3>
                דוכן - שבירת בקבוקים
                <Tooltip Text="בדוכן זה ניתן להוסיף שאלות חד-ברירה. לכל תיאור שאלה ניתן להוסיף גם תמונה. עבור מסיחים ניתן להוסיף טקסט או תמונה."><i class="fa fa-info-circle" style="font-size:18px;"> </i> </Tooltip>
            </h3>

        </div>
        <div class="col-md-5 text-end">
            <button type="button" class="btn btn-secondary">כיבוי דוכן</button>
        </div>
    </div>

    <!-- ROW 2 - FORM AND QUESTION LIST -->
    <div class="row">
        <!-- Edit Form Column -->
        <div class="col-md-7 ">
            <div class="row mb-3">
                <div class="col col-12">
                    <span> שאלה</span>
                    <span>(2-30 טווח תווים)</span>
                </div>
            </div>

            <EditForm Model="questionsAndAnswers" OnValidSubmit="HandleSubmit" OnInvalidSubmit="failedSubmit">
                <DataAnnotationsValidator />

                <!-- ROW - Form Input Fields -->
                <div class="mb-3 d-flex align-items-center">
                    <div class="col-8 p-0">
                        <InputText maxlength="@QuestionDescriptionMaxChars"
                                   class="form-control"
                                   id="question"
                                   @bind-Value="QuestionDescription"
                                   @oninput="@(e => HandleInputChange(e, nameof(questionsAndAnswers.Questions.QuestionDescription)))"
                                   placeholder="שאלה"
                                   aria-describedby="questionDescription" required />


                    </div>

                    <div class="col-1">
                        <small id="questionDescription" class="@GetInputClass(QuestionDescription.Length, 2, @QuestionDescriptionMaxChars)">
                            @QuestionDescription.Length/@QuestionDescriptionMaxChars
                        </small>
                    </div>

                    <div class="col-1 d-flex justify-content-end pe-0">
                        <label class="btn btn-outline-secondary " for="FileInputID">
                            <i class="fa-solid fa-image "></i>
                        </label>
                        <InputFile id="FileInputID" OnChange="UploadFile" hidden />
                    </div>
                    <div class="col-2 ps-1">

                        @if (myFileImage != "")
                        {
                            <div class="img-wrapper">
                                <img src="@myFileImage" width="34" />
                                <i class="fa-solid fa-trash  delete-image-btn" @onclick="MakeDeleteList"></i>
                            </div>
                        }
                    </div>
                </div>

                <div class="mb-3 mt-3 col-9"> </div>

                <!-- Row -->
                <div class="row mb-3">
                    <div class="col col-12">
                        <span>תשובות לשאלה</span>
                        <span>(2-30 טווח תווים)</span>
                    </div>
                </div>

                <!-- Correct Answer -->
                <label for="correctAnswer" class="form-label">תשובה נכונה:</label>
                <div class="mb-3 align-items-center">

                    <div class="col-7">
                        <InputText maxlength="@AnswersDescriptionMaxChars"
                                   class="form-control"
                                   id="correctAnswer"
                                   @bind-Value="CorrectAnswer"
                                   @oninput="@(e => HandleInputChange(e, nameof(CorrectAnswer)))"
                                   placeholder="תשובה נכונה"
                                   aria-describedby="correctAnswer" required />
                    </div>
                    <div class="col-3 p-0">
                        <small id="correctAnswer" class="@GetInputClass(CorrectAnswer.Length, 2, @AnswersDescriptionMaxChars)
                            col-2 p-0 d-flex justify-content-start">@CorrectAnswer.Length/@AnswersDescriptionMaxChars</small>
                    </div>

                </div>


                <span>תשובות נוספות:</span>

                <!-- Wrong Answer 1 -->
                <div class="d-flex align-items-center mb-3">
                    <div class="col-7 p-0">
                        <InputText maxlength="@AnswersDescriptionMaxChars"
                                   class="form-control"
                                   @bind-Value="WrongAnswer1"
                                   @oninput="@(e => HandleInputChange(e, nameof(WrongAnswer1)))"
                                   placeholder="תשובה שגויה"
                                   aria-describedby="wrongAnswer1" required />
                    </div>
                    <div class="col-3 p-0">
                        <small id="wrongAnswer1" class="@GetInputClass(WrongAnswer1.Length, 2, @AnswersDescriptionMaxChars)
                            col-2 p-0 d-flex justify-content-start">@WrongAnswer1.Length/30</small>
                    </div>
                </div>

                <!-- Wrong Answer 2 -->
                <div class="d-flex align-items-center mb-3">
                    <div class="col-7 p-0">
                        <InputText maxlength="@AnswersDescriptionMaxChars"
                                   class="form-control"
                                   @bind-Value="WrongAnswer2"
                                   @oninput="@(e => HandleInputChange(e, nameof(WrongAnswer2)))"
                                   placeholder="תשובה שגויה"
                                   aria-describedby="wrongAnswer2" required />
                    </div>
                    <div class="col-3 p-0">
                        <small id="wrongAnswer2" class="@GetInputClass(WrongAnswer2.Length, 2, @AnswersDescriptionMaxChars)
                            col-2 p-0 d-flex justify-content-start">@WrongAnswer2.Length/30</small>
                    </div>
                </div>

                <!-- Wrong Answer 3 -->
                <div class="d-flex align-items-center mb-3">
                    <div class="col-7 p-0">
                        <InputText maxlength="@AnswersDescriptionMaxChars"
                                   class="form-control"
                                   @bind-Value="WrongAnswer3"
                                   @oninput="@(e => HandleInputChange(e, nameof(WrongAnswer3)))"
                                   placeholder="תשובה שגויה"
                                   aria-describedby="wrongAnswer3" required />
                    </div>
                    <div class="col-3 p-0">
                        <small id="wrongAnswer3" class="@GetInputClass(WrongAnswer3.Length, 2, @AnswersDescriptionMaxChars)
                            col-2 p-0 d-flex justify-content-start">@WrongAnswer3.Length/30</small>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="mt-3 mb-2">
                    <button type="submit" id="liveToastBtn" class="btn btn-primary shadow-sm">שמירת שאלה</button>
                </div>

            </EditForm>
        </div>

        <!-- Question List Column -->
        @if (questions.Count > 0)
        {
            <div class="col-md-5 mt-4">
                <h5>רשימת שאלות</h5>
                <div class="scrollable-table-body ">
                    <table class="table shadow-sm table-striped table-hover table-responsive border border-1">
                        <thead>
                            <tr>
                                <th>שאלה</th>
                                <th class="text-center">עריכה</th>
                                <th class="text-center">מחיקה</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var question in questions)
                            {
                                <tr>
                                    <td>@question.QuestionDescription</td>
                                    <td class="text-center"><button class="btn btn-outline-primary btn-sm" @onclick="()=>EditQuestion(question)"><i class="fa-solid fa-square-pen fa-fw" style="width: 14px;"></i></button></td>
                                    <td class="text-center">
                                        <button class="btn btn-outline-danger btn-sm" @onclick="() => selectedQuestionForDeletion = question"
                                                data-bs-toggle="modal" data-bs-target="#deleteConfirmationModal">
                                            <i class="fa-solid fa-trash fa-fw" style="width: 14px;"></i>
                                        </button>



                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }
    </div>

    <div class="toast-container position-fixed top-0 end-0 p-3">
        <!--TOAST comes here-->
    </div>


    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">מחיקת משחק</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    מחיקת השאלה תתבצע לצמיתות וללא יכולת שחזור, בטוחים?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ביטול</button>
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal" @onclick="ConfirmDelete">מחיקה</button>
                </div>
            </div>
        </div>
    </div>






</div>

@if (msg != "")
{
    <p>@msg</p>
}


@code {
    #region Variables
    [CascadingParameter] public int UserId { get; set; } // Inject UserId

    [Parameter] public string gameCode { get; set; } // Inject gameCode
    [Parameter] public GameDetails game { get; set; }
    [Parameter] public int stage { get; set; }
    [Parameter] public EventCallback<GameQuestions> OnQuestionAdded { get; set; }
    [Parameter] public EventCallback<GameQuestions> OnQuestionDeleted { get; set; }

    private GameDetails gameDetails = new GameDetails();
    private QuestionToAdd questionToAdd = new QuestionToAdd();
    private GameAnswers answersToAdd = new GameAnswers();
    List<GameQuestions> questions = new List<GameQuestions>();

    private QuestionsAndAnswers questionsAndAnswers = new QuestionsAndAnswers();
    private int newQuestionCreated;

    string QuestionDescription = string.Empty;
    string CorrectAnswer = string.Empty;
    string WrongAnswer1 = string.Empty;
    string WrongAnswer2 = string.Empty;
    string WrongAnswer3 = string.Empty;

    int QuestionDescriptionCount => QuestionDescription.Length;
    int CorrectAnswerCount => CorrectAnswer.Length;
    int WrongAnswer1Count => WrongAnswer1.Length;
    int WrongAnswer2Count => WrongAnswer2.Length;
    int WrongAnswer3Count => WrongAnswer3.Length;

    int QuestionDescriptionMaxChars = 50;
    int AnswersDescriptionMaxChars = 30;

    bool hasimage = false;
    private IBrowserFile questionImageFile;
    private string imagePreview;
    string myFileImage = "";
    long maxFileSize = 4194304; //4MB
    private EditContext editContext;


    string msg = "";
    bool isDeleteModalOpen = false;

    List<string> DeleteImages = new List<string>();

    string questionDescriptionClass = "text-muted"; // Default class
    private GameQuestions selectedQuestionForDeletion;


    #endregion

    /*METHODS*/

    protected override async Task OnInitializedAsync()
    {
        questions = game.Questions;
    }

    private void HandleInputChange(ChangeEventArgs e, string inputType)
    {
        var newValue = e.Value.ToString();

        switch (inputType)
        {
            case "QuestionDescription":
                QuestionDescription = newValue;
                break;
            case "CorrectAnswer":
                CorrectAnswer = newValue;
                break;
            case "WrongAnswer1":
                WrongAnswer1 = newValue;
                break;
            case "WrongAnswer2":
                WrongAnswer2 = newValue;
                break;
            case "WrongAnswer3":
                WrongAnswer3 = newValue;
                break;
            default:
                break;
        }
        StateHasChanged();
    }

    private async Task HandleSubmit()
    {
        if (string.IsNullOrWhiteSpace(CorrectAnswer) || CorrectAnswer.Length < 2 || CorrectAnswer.Length > AnswersDescriptionMaxChars ||
            string.IsNullOrWhiteSpace(WrongAnswer1) || WrongAnswer1.Length < 2 || WrongAnswer1.Length > AnswersDescriptionMaxChars ||
            string.IsNullOrWhiteSpace(WrongAnswer2) || WrongAnswer2.Length < 2 || WrongAnswer2.Length > AnswersDescriptionMaxChars ||
            string.IsNullOrWhiteSpace(WrongAnswer3) || WrongAnswer3.Length < 2 || WrongAnswer3.Length > AnswersDescriptionMaxChars)
        {
            ShowToast(false, "הזינו שאלה ותשובות במבנה המתאים", "fa-solid fa-circle-exclamation");
            return;
        }

        var newQuestion = await AddQuestion();
        if (newQuestion != null)
        {
            // Check if the new question is already in the list to avoid duplication
            if (!questions.Any(q => q.ID == newQuestion.ID))
            {
                questions.Add(newQuestion);
                questions = new List<GameQuestions>(questions); // Re-assign to force UI update
            }
            await AddAnswers(newQuestion.ID);
            await ShowToast(true, "השאלה נשמרה בהצלחה!", "fa-solid fa-circle-check");

            StateHasChanged();
            ClearFormFields();
        }
    }

    private async Task ShowToast(bool isSuccess, string message, string icon)
    {
        await JS.InvokeVoidAsync("showToast", isSuccess, message, icon);
    }

    void failedSubmit()
    {
        StateHasChanged();
    }

    private async Task<GameQuestions> AddQuestion()
    {
        bool hasImage = !string.IsNullOrEmpty(myFileImage);

        QuestionToAdd questionToAdd = new QuestionToAdd()
            {
                GameID = game.ID,
                HasImage = hasImage,
                QuestionDescription = QuestionDescription,
                QuestionImage = myFileImage,
                StageID = 1,
            };

        var url = $"api/game/{UserId}/addQuestion/{gameCode}";
        var response = await Http.PostAsJsonAsync(url, questionToAdd);
        if (response.IsSuccessStatusCode)
        {
            var result = await response.Content.ReadAsStringAsync();
            int questionId = int.Parse(result);
            Console.WriteLine("Successful Question Creation - ID: " + result);
            GameQuestions newQuestion = new GameQuestions
                {
                    ID = questionId,
                    QuestionDescription = QuestionDescription
                };
            await OnQuestionAdded.InvokeAsync(newQuestion);
            return newQuestion;
        }
        else
        {
            Console.WriteLine("Error: " + response.StatusCode);
            return null;
        }
    }

    private async Task<bool> AddAnswers(int questionId)
    {
        List<GameAnswers> answers = new List<GameAnswers>()
    {
        new GameAnswers { AnswerDescription = CorrectAnswer, IsCorrect = true, QuestionID = questionId },
        new GameAnswers { AnswerDescription = WrongAnswer1, IsCorrect = false, QuestionID = questionId },
        new GameAnswers { AnswerDescription = WrongAnswer2, IsCorrect = false, QuestionID = questionId },
        new GameAnswers { AnswerDescription = WrongAnswer3, IsCorrect = false, QuestionID = questionId }
    };

        // Validate the answers list (optional, depending on your requirements)
        // You can add validation logic here if needed

        var response = await Http.PostAsJsonAsync($"api/game/{UserId}/addAnswers/{questionId}", answers);
        if (response.IsSuccessStatusCode)
        {
            Console.WriteLine("Successful Answers Creation");
            return true; // Return true indicating successful creation
        }
        else
        {
            Console.WriteLine("Failed to add answers: " + await response.Content.ReadAsStringAsync());
            return false; // Return false indicating failure to add answers
        }
    }

    private void EditQuestion(GameQuestions question)
    {
        Nav.NavigateTo($"/edit-question/{question.ID}");
    }


    async Task ConfirmDelete()
    {
        if (selectedQuestionForDeletion != null)
        {
            await DeleteQuestion(selectedQuestionForDeletion);
            selectedQuestionForDeletion = null; // Reset the selected question
            isDeleteModalOpen = false; // Close the modal
            StateHasChanged(); // Refresh UI
        }
    }



    private async Task DeleteQuestion(GameQuestions question)
    {
        var response = await Http.DeleteAsync($"api/game/{UserId}/deleteQuestion/{question.ID}");
        if (response.IsSuccessStatusCode)
        {
            // Remove the question from the local list and update UI
            questions.Remove(question);
            StateHasChanged(); // Call this to refresh the component if not automatically updating
            await ShowToast(true, "השאלה נמחקה בהצלחה.", "fa-solid fa-circle-check");

            await OnQuestionDeleted.InvokeAsync(question);
        }
        else
        {
            ShowToast(false, "פעולת המחיקה נכשלה", "fa-solid fa-circle-exclamation");

            Console.WriteLine("Failed to delete question: " + await response.Content.ReadAsStringAsync());
        }
    }

    private string GetInputClass(int length, int minChars, int maxChars)
    {
        string resultClass;
        if (length == 0)
            resultClass = "text-muted"; // Neutral for zero characters
        else if (length < minChars)
            resultClass = "text-danger";  // Red for less than minimum characters
        else if (length >= minChars && length < maxChars - 3)
            resultClass = "text-good";   // Green for within the normal range
        else if (length >= maxChars - 3 && length <= maxChars)
            resultClass = "text-warning";  // Orange for nearing maximum length
        else
            resultClass = "text-muted";  // Fallback

        return resultClass;
    }

    private async Task UploadFile(InputFileChangeEventArgs e)
    {
        var imageFiles = e.GetMultipleFiles();
        foreach (var file in imageFiles)
        {
            if (file.Size <= maxFileSize)
            {
                var buffer = new byte[file.Size];
                await file.OpenReadStream(maxFileSize).ReadAsync(buffer);
                var imageBase64 = Convert.ToBase64String(buffer);
                var saveResponse = await Http.PostAsJsonAsync("api/media/upload", imageBase64);

                if (saveResponse.IsSuccessStatusCode == true)
                {
                    string resizeUrl = saveResponse.Content.ReadAsStringAsync().Result;
                    myFileImage = "uploadedFiles/" + resizeUrl;
                }
            }
        }
    }

    private void MakeDeleteList()
    {
        DeleteImages.Add(myFileImage);
        myFileImage = "";
    }

    private void ClearFormFields()
    {
        // Reset properties within the questionsAndAnswers model
        questionsAndAnswers.Questions.QuestionDescription = string.Empty;
        QuestionDescription = "";
        CorrectAnswer = "";
        WrongAnswer1 = "";
        WrongAnswer2 = "";
        WrongAnswer3 = "";
        myFileImage = ""; // Clear any image that might have been uploaded

        // This should explicitly set to 'text-muted'
        questionDescriptionClass = GetInputClass(0, 2, QuestionDescriptionMaxChars);

        StateHasChanged();
    }

    private async Task DeleteImage()
    {
        var saveResponse = await Http.PostAsJsonAsync("api/Media/deleteImages", DeleteImages);
        if (saveResponse.IsSuccessStatusCode == true)
        {
            msg = "deleted Successfully";
            DeleteImages.Clear();
        }
        else
        {
            msg = "DELETE ERROR";
        }
    }
}